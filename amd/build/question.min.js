/**
 * JavaScript to allow dragging options for lines (using mouse down or touch) or tab through lines using keyboard.
 *
 * @module     qtype_drawlines/question
 * @copyright  2024 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_drawlines/question",["jquery","core/dragdrop","qtype_drawlines/line","core/key_codes","core_form/changechecker"],(function($,dragDrop,Line){function DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines){var thisQ=this;this.containerId=containerId,this.visibleDropZones=visibleDropZones,this.questionLines=questionLines,this.lineSVGs=[],this.lines=[],this.svgEl=null,readOnly&&this.getRoot().classList.add("qtype_drawlines-readonly"),thisQ.allImagesLoaded=!1;const images=thisQ.getNotYetLoadedImages();images&&images.forEach((imgNode=>{imgNode.addEventListener("load",(function(){thisQ.waitForAllImagesToBeLoaded()}),{once:!0})})),thisQ.waitForAllImagesToBeLoaded()}DrawlinesQuestion.prototype.updateCoordinates=function(){for(var line=0;line<this.lineSVGs.length;line++){var coordinates=this.getSVGLineCoordinates(this.lineSVGs[line]);if(!this.lines[line].parse(coordinates[0],coordinates[1],1))return;this.updateSvgEl(line)}},DrawlinesQuestion.prototype.parseCoordinates=function(coordinates,lineType){var bits=coordinates.split(" ");if("lineinfinite"===lineType&&2!==bits.length&&(bits=bits.slice(1,-1)),2!==bits.length)throw new Error(coordinates+" is not a valid point");return bits},DrawlinesQuestion.prototype.drawDropzone=function(){var bgImage=this.bgImage(),svg=this.getRoot().querySelector("svg.dropzones"),rootElement=this.getRoot();(rootElement.querySelector(".que-dlines-dropzone").style.position="relative",rootElement.querySelector(".que-dlines-dropzone").style.top=-1*(bgImage.height+1)+"px",rootElement.querySelector(".que-dlines-dropzone").style.height=bgImage.height+"px",rootElement.querySelector(".droparea").style.height=bgImage.height+"px",svg)||(this.getRoot().querySelector(".que-dlines-dropzone").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class= "dropzones" width="'+bgImage.width+'" height="'+bgImage.height+'" ></svg>');this.drawSVGLines(this.questionLines)},DrawlinesQuestion.prototype.drawSVGLines=function(questionLines){var height,startcoordinates,endcoordinates,draginitialcoords,bgImage=this.bgImage();this.getRoot().querySelector(".draghomes").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="dragshome" width="'+bgImage.width+'" height="'+50*questionLines.length+'"></svg>';var draghomeSvg=this.getRoot().querySelector(".dragshome"),dropzoneSvg=this.getRoot().querySelector(".dropzones");for(let line=0;line<questionLines.length;line++)if(startcoordinates="50,"+(height=25+50*line)+";10",endcoordinates="200,"+height+";10",void 0!==(draginitialcoords=this.visibleDropZones["c"+line])&&""!==draginitialcoords){var coords=this.parseCoordinates(draginitialcoords,questionLines[line].type);startcoordinates=coords[0]+";10",endcoordinates=coords[1]+";10",this.lines[line]=Line.make([startcoordinates,endcoordinates],[questionLines[line].labelstart,questionLines[line].labelend],questionLines[line].type),this.addToSvg(line,dropzoneSvg)}else this.lines[line]=Line.make([startcoordinates,endcoordinates],[questionLines[line].labelstart,questionLines[line].labelend],questionLines[line].type),this.addToSvg(line,draghomeSvg)},DrawlinesQuestion.prototype.getRoot=function(){return document.getElementById(this.containerId)},DrawlinesQuestion.prototype.bgImage=function(){return this.getRoot().querySelector("img.dropbackground")},DrawlinesQuestion.prototype.getSVGLineCoordinates=function(svgEl){return[svgEl.childNodes[1].getAttribute("cx")+","+svgEl.childNodes[1].getAttribute("cy")+";"+svgEl.childNodes[1].getAttribute("r"),svgEl.childNodes[2].getAttribute("cx")+","+svgEl.childNodes[2].getAttribute("cy")+";"+svgEl.childNodes[2].getAttribute("r")]},DrawlinesQuestion.prototype.bgRatio=function(){var bgImg=this.bgImage(),bgImgNaturalWidth=bgImg.get(0).naturalWidth;return bgImg.width()/bgImgNaturalWidth},DrawlinesQuestion.prototype.addToSvg=function(lineNumber,svg){this.lineSVGs[lineNumber]=this.lines[lineNumber].makeSvg(svg),this.lineSVGs[lineNumber]&&(this.lineSVGs[lineNumber].setAttribute("data-dropzone-no",lineNumber),"dropzones"===svg.getAttribute("class")?this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" placed"):this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" inactive"))},DrawlinesQuestion.prototype.updateSvgEl=function(dropzoneNo){this.lines[dropzoneNo].updateSvg(this.lineSVGs[dropzoneNo])},DrawlinesQuestion.prototype.handleCircleMove=function(e,whichHandle,dropzoneNo){var info=dragDrop.prepare(e);if(info.start){var movingDropZone=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),svg=this.getRoot().querySelector("svg.dropzones"),maxX=svg.width.baseVal.value,maxY=svg.height.baseVal.value;dragDrop.start(e,$(dragProxy),(function(pageX,pageY){movingDropZone.lines[dropzoneNo].move(whichHandle,parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY)),lastX=pageX,lastY=pageY,movingDropZone.updateSvgEl(dropzoneNo),movingDropZone.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))}},DrawlinesQuestion.prototype.handleLineMove=function(e,dropzoneNo){var info=dragDrop.prepare(e);if(!info.start)return;var maxX,maxY,isMoveFromDragsToDropzones,isMoveFromDropzonesToDrags,movingDrag=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),whichSVG="",bgImage=this.bgImage(),svgClass="",selectedElement=this.lineSVGs[dropzoneNo];const dropX=e.clientX,dropY=e.clientY;dragDrop.start(e,$(dragProxy),(function(pageX,pageY){var closestSVGs=movingDrag.getSvgsClosestToElement(selectedElement),closeTo=selectedElement.closest("svg");svgClass=closeTo.getAttribute("class"),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&movingDrag.lines[dropzoneNo].centre1.y>bgImage.height-20,(isMoveFromDragsToDropzones||isMoveFromDropzonesToDrags)&&movingDrag.lines[dropzoneNo].addToDropZone("mouse",selectedElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,dropX,dropY),closeTo=selectedElement.closest("svg");var dimensions=movingDrag.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,whichSVG=dimensions.whichSVG,movingDrag.lines[dropzoneNo].moveDrags(parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY),whichSVG),lastX=pageX,lastY=pageY,movingDrag.updateSvgEl(dropzoneNo),movingDrag.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))},DrawlinesQuestion.prototype.makeDragProxy=function(x,y){var dragProxy=document.createElement("div");return dragProxy.style.position="absolute",dragProxy.style.top=y+"px",dragProxy.style.left=x+"px",dragProxy.style.width="1px",dragProxy.style.height="1px",document.body.appendChild(dragProxy),dragProxy},DrawlinesQuestion.prototype.saveCoordsForChoice=function(choiceNo){let imageCoords=[];var items=this.getRoot().querySelector("svg g.choice"+choiceNo),gEleClassAttributes="";items&&(imageCoords=items.querySelector("polyline").getAttribute("points"),gEleClassAttributes=items.getAttribute("class")),""!==gEleClassAttributes&&gEleClassAttributes.includes("placed")?this.getRoot().querySelector("input.choice"+choiceNo).value=imageCoords:""!==gEleClassAttributes&&gEleClassAttributes.includes("inactive")&&(this.getRoot().querySelector("input.choice"+choiceNo).value="")},DrawlinesQuestion.prototype.handleKeyPress=function(e,drag,dropzoneNo,activeElement){var dropzoneElement,x=0,y=0,question=questionManager.getQuestionForEvent(e);switch(dropzoneElement=event.target.closest("g"),e.code){case"ArrowLeft":case"KeyA":x=-1;break;case"ArrowRight":case"KeyD":x=1;break;case"ArrowDown":case"KeyS":y=1;break;case"ArrowUp":case"KeyW":y=-1;break;case"Space":case"Escape":break;default:return}e.preventDefault();var maxX,maxY,whichSVG,closeTo=drag.closest("svg"),svgClass=closeTo.getAttribute("class"),bgImage=this.bgImage(),closestSVGs=this.getSvgsClosestToElement(drag),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&question.lines[dropzoneNo].centre1.y>bgImage.height-20;isMoveFromDragsToDropzones?question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,null,null,"DragsSVG"):isMoveFromDropzonesToDrags&&question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,closestSVGs.svgDropZone,closestSVGs.svgDragsHome,null,null,"DropZonesSVG"),closeTo=drag.closest("svg");var dimensions=question.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,whichSVG=dimensions.whichSVG,"line"===activeElement?question.lines[dropzoneNo].moveDrags(x,y,parseInt(maxX),parseInt(maxY),whichSVG):question.lines[dropzoneNo].move(activeElement,x,y,parseInt(maxX),parseInt(maxY)),question.updateSvgEl(dropzoneNo),this.saveCoordsForChoice(dropzoneNo),drag.focus()},DrawlinesQuestion.prototype.getSvgDimensionsByClass=function(dragSVG,className){return{maxX:dragSVG.width.baseVal.value,maxY:dragSVG.height.baseVal.value,whichSVG:"dragshome"===className?"DragsSVG":"DropZonesSVG"}},DrawlinesQuestion.prototype.getSvgsClosestToElement=function(dragElement){var svgDragsHome,svgDropZone,svgElement=dragElement.closest("svg");return"dragshome"===svgElement.getAttribute("class")?(svgDragsHome=svgElement,svgDropZone=svgElement.closest(".ddarea").querySelector(".dropzones")):(svgDropZone=svgElement,svgDragsHome=svgElement.closest(".ddarea").querySelector(".dragshome")),{svgDropZone:svgDropZone,svgDragsHome:svgDragsHome}},DrawlinesQuestion.prototype.waitForAllImagesToBeLoaded=function(){if(this.allImagesLoaded)return;null!==this.imageLoadingTimeoutId&&clearTimeout(this.imageLoadingTimeoutId);const images=this.getNotYetLoadedImages();images&&images.length>0?this.imageLoadingTimeoutId=setTimeout((function(){this.waitForAllImagesToBeLoaded()}),100):(this.allImagesLoaded=!0,this.drawDropzone())},DrawlinesQuestion.prototype.getNotYetLoadedImages=function(){const images=this.getRoot().querySelectorAll(".drawlines img.dropbackground");Array.from(images).filter((imgNode=>!this.imageIsLoaded(imgNode)))},DrawlinesQuestion.prototype.imageIsLoaded=function(imgElement){return imgElement.complete&&0!==imgElement.naturalHeight};var questionManager={eventHandlersInitialised:!1,lineEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},noOfLines:null,dropZones:[],questionLines:[],init:function(containerId,readOnly,visibleDropZones,questionLines){if(questionManager.questions[containerId]=new DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines),questionManager.questions[containerId].updateCoordinates(),!questionManager.lineEventHandlersInitialised.hasOwnProperty(containerId)){questionManager.lineEventHandlersInitialised[containerId]=!0;var questionContainer=document.getElementById(containerId);if(questionContainer.classList.contains("drawlines")&&!questionContainer.classList.contains("qtype_drawlines-readonly")){var dropArea=questionContainer.querySelector(".droparea");dropArea.addEventListener("mousedown",questionManager.handleDropZoneEventMove),dropArea.addEventListener("touchstart",questionManager.handleDropZoneEventMove),dropArea.addEventListener("keydown",questionManager.handleKeyPress),dropArea.addEventListener("keypress",questionManager.handleKeyPress);var drags=questionContainer.querySelector(".draghomes");drags.addEventListener("mousedown",questionManager.handleDragHomeEventMove),drags.addEventListener("touchstart",questionManager.handleDragHomeEventMove),drags.addEventListener("keydown",questionManager.handleKeyPress),drags.addEventListener("keypress",questionManager.handleKeyPress)}}},handleDropZoneEventMove:function(event){var dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest(".dropzone .startcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"startcircle",dropzoneNo)):event.target.closest(".dropzone .endcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"endcircle",dropzoneNo)):event.target.closest("polyline.shape")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo))},handleDragHomeEventMove:function(event){var dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest("g")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo),question.saveCoordsForChoice(dropzoneNo))},handleKeyPress:function(e){var dropzoneElement,dropzoneNo,drag,activeElement,question=questionManager.getQuestionForEvent(e);e.target.closest(".dropzone circle.startcircle")?(dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,drag=e.target.closest(".dropzone circle.startcircle"),activeElement="startcircle"):e.target.closest(".dropzone circle.endcircle")?(drag=e.target.closest(".dropzone circle.endcircle"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="endcircle"):e.target.closest(".dropzone polyline.shape")&&(drag=e.target.closest(".dropzone polyline.shape"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="line"),question&&dropzoneElement&&question.handleKeyPress(e,drag,dropzoneNo,activeElement)},handleWindowResize:function(isPrinting){for(var containerId in questionManager.questions)questionManager.questions.hasOwnProperty(containerId)&&(questionManager.questions[containerId].isPrinting=isPrinting,questionManager.questions[containerId].handleResize())},getQuestionForEvent:function(e){var containerId=$(e.currentTarget).closest(".que.drawlines").attr("id");return questionManager.questions[containerId]}};return{init:questionManager.init}}));

//# sourceMappingURL=question.min.js.map